<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Premium Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #fff; min-height: 100vh; overflow-x: hidden; }

    .glow-bg {
      position: fixed; inset: 0; pointer-events: none;
      background: radial-gradient(circle at 50% 25%, rgba(255,255,255,0.15) 0%, transparent 70%);
      animation: pulse 6s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { opacity:0.5; transform:scale(1); } 50% { opacity:0.95; transform:scale(1.1); } }

    .container { padding: 20px; padding-top: 60px; padding-bottom: 100px; position: relative; z-index: 1; }

    .tab { display: none; }
    .tab.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:none; } }

    .profile-card {
      margin: 0 16px 32px; padding: 40px 24px; text-align: center;
      background: rgba(255,255,255,0.07); backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12); border-radius: 24px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .profile-card:hover { transform: translateY(-10px) rotateX(5deg); box-shadow: 0 40px 80px rgba(0,0,0,0.7); }

    .avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); object-fit: cover; margin-bottom: 20px; background:#111; }
    .username { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .first-visit { font-size: 13px; opacity: 0.7; margin-bottom: 20px; }

    .btn {
      width: calc(100% - 32px); margin: 0 16px 16px; padding: 18px;
      background: #fff; color: #000; font-size: 17px; font-weight: 600;
      border: none; border-radius: 16px; cursor: pointer; transition: all 0.25s;
    }
    .btn:active { transform: translateY(2px); background: #eee; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }

    /* Темы */
    .topic-item {
      margin: 0 16px 12px; padding: 18px 20px;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px; display: flex; align-items: center; gap: 16px;
      font-size: 16px;
    }
    .topic-item i { font-size: 24px; opacity: 0.8; }

    /* Админ-панель */
    .admin-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 16px;
    }
    .admin-btn { padding: 16px; text-align: center; background: rgba(255,255,255,0.08); border-radius: 12px; font-size: 14px; }

    /* Модальное окно ввода ключа */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #111; padding: 32px; border-radius: 20px; width: 90%; max-width: 360px;
      text-align: center; border: 1px solid rgba(255,255,255,0.1);
    }
    .modal input {
      width: 100%; padding: 16px; margin: 16px 0; background: #222; border: none; border-radius: 12px; color: #fff; font-size: 18px; text-align: center;
    }

    /* Навигация */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: 84px;
      background: rgba(15,15,15,0.95); backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex; justify-content: space-around; align-items: center; z-index: 1000;
    }
    .nav-item { text-align: center; color: rgba(255,255,255,0.5); transition: all 0.3s; flex: 1; }
    .nav-item.active { color: #fff; }
    .nav-item i { font-size: 26px; margin-bottom: 4px; display: block; }
    .nav-label { font-size: 11px; font-weight: 500; }
  </style>
</head>
<body>

  <div class="glow-bg"></div>

  <div class="container">
    <!-- Главная -->
    <div id="tab-home" class="tab active">
      <div class="profile-card">
        <img id="userAvatar" class="avatar" src="" alt="">
        <div class="username" id="userName">—</div>
        <div class="first-visit">Первый вход: <span id="visitDate">—</span></div>
        <div id="status" style="margin-top:16px; font-size:14px; opacity:0.7;">
          Подписка: <span id="subStatus">Не активна</span>
        </div>
      </div>
      <button class="btn" onclick="openKeyModal()">Активировать ключ</button>
    </div>

    <!-- Темы -->
    <div id="tab-themes" class="tab">
      <h2 style="margin:0 16px 20px; font-size:20px;">Темы</h2>
      <div class="topic-item"><i data-feather="message-square"></i> Общение <span style="margin-left:auto; opacity:0.6;">0 сообщений</span></div>
      <div class="topic-item"><i data-feather="volume-2"></i> Объявления <span style="margin-left:auto; opacity:0.6;">Только админы</span></div>
      <div class="topic-item" style="color:#ff4444;"><i data-feather="alert-triangle"></i> Поддержка <span style="margin-left:auto; opacity:0.6;">0 сообщений</span></div>
      <div class="topic-item"><i data-feather="code"></i> Разработка <span style="margin-left:auto; opacity:0.6;">0 сообщений</span></div>
      <div class="topic-item"><i data-feather="film"></i> Медиа <span style="margin-left:auto; opacity:0.6;">0 сообщений</span></div>
      <div class="topic-item"><i data-feather="gamepad-2"></i> Игры <span style="margin-left:auto; opacity:0.6;">0 сообщений</span></div>
    </div>

    <!-- Подписка (заглушка) -->
    <div id="tab-sub" class="tab">
      <h2 style="text-align:center; margin:40px 20px; opacity:0.7;">Скоро здесь будет магазин подписок</h2>
    </div>

    <!-- Админ-панель (только для Xanezy) -->
    <div id="tab-admin" class="tab">
      <h2 style="margin:0 16px 20px; font-size:20px;">Админ-панель</h2>
      <div class="admin-grid">
        <button class="admin-btn" onclick="generateKey(3)">3 дня</button>
        <button class="admin-btn" onclick="generateKey(5)">5 дней</button>
        <button class="admin-btn" onclick="generateKey(10)">10 дней</button>
        <button class="admin-btn" onclick="generateKey(30)">30 дней</button>
        <button class="admin-btn" onclick="generateKey(9999)">Навсегда</button>
        <button class="admin-btn" onclick="alert('Ключ скопирован: ' + lastKey)" id="copyBtn" style="grid-column:1/3; display:none;">Скопировать последний ключ</button>
      </div>
      <div id="lastKeyDisplay" style="margin:20px 16px; padding:16px; background:rgba(0,255,0,0.1); border-radius:12px; text-align:center; font-family:monospace; font-size:18px; display:none;"></div>
    </div>
  </div>

  <!-- Модальное окно ввода ключа -->
  <div class="modal" id="keyModal">
    <div class="modal-content">
      <h3>Активация ключа</h3>
      <input type="text" id="keyInput" placeholder="XXXXXX" maxlength="6">
      <button class="btn" onclick="activateKey()">Активировать</button>
      <p style="margin-top:20px; opacity:0.7;">
        Нет ключа? 
        <a href="#" onclick="switchTab('tab-sub'); closeModal();" style="color:#fff; text-decoration:underline;">
          Приобрести ключ для проходки
        </a>
      </p>
    </div>
  </div>

  <!-- Навигация -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('tab-home', this)">
      <i data-feather="home"></i><div class="nav-label">Главная</div>
    </div>
    <div class="nav-item" id="themesTab" onclick="switchTab('tab-themes', this)" style="display:none;">
      <i data-feather="grid"></i><div class="nav-label">Темы</div>
    </div>
    <div class="nav-item" id="adminTab" onclick="switchTab('tab-admin', this)" style="display:none;">
      <i data-feather="shield"></i><div class="nav-label">Админ</div>
    </div>
  </div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    feather.replace();

    const user = Telegram.WebApp.initDataUnsafe.user || {};
    const userId = user.id;
    const username = user.username;
    const isAdmin = (userId === 8223197188 || username === 'Xanezy');

    let lastKey = '';

    // Показ админки
    if (isAdmin) document.getElementById('adminTab').style.display = 'block';

    // Профиль
    document.getElementById('userName').textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Пользователь';
    if (!user.photo_url) {
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 100;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,100,100);
      ctx.font = 'bold 40px Inter'; ctx.fillStyle = '#fff';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText((user.first_name?.[0] || '?').toUpperCase(), 50, 50);
      document.getElementById('userAvatar').src = canvas.toDataURL();
    } else {
      document.getElementById('userAvatar').src = user.photo_url;
    }

    // Дата первого входа
    const saved = localStorage.getItem('firstVisit');
    const now = new Date();
    const dateStr = now.getFullYear() + '.' + String(now.getMonth()+1).padStart(2,'0') + '.' + String(now.getDate()).padStart(2,'0') + ', ' + now.toTimeString().slice(0,8);
    if (!saved) localStorage.setItem('firstVisit', dateStr);
    document.getElementById('visitDate').textContent = saved || dateStr;

    // Подписка
    function checkSubscription() {
      const sub = localStorage.getItem('subscription');
      if (sub) {
        const { expires } = JSON.parse(sub);
        if (expires === 'forever' || Date.now() < expires) {
          document.getElementById('subStatus').textContent = expires === 'forever' ? 'Навсегда' : 'Активна';
          document.getElementById('themesTab').style.display = 'block';
        }
      }
    }
    checkSubscription();

    // Генерация ключа
    function generateKey(days) {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let key = '';
      for (let i = 0; i < 6; i++) key += chars[Math.floor(Math.random() * chars.length)];
      lastKey = key;

      const expires = days >= 9999 ? 'forever' : Date.now() + days * 24 * 60 * 60 * 1000;
      const keyData = { key, expires, used: false };
      let keys = JSON.parse(localStorage.getItem('generatedKeys') || '[]');
      keys.push(keyData);
      localStorage.setItem('generatedKeys', JSON.stringify(keys));

      document.getElementById('lastKeyDisplay').textContent = key;
      document.getElementById('lastKeyDisplay').style.display = 'block';
      document.getElementById('copyBtn').style.display = 'block';
      document.getElementById('copyBtn').onclick = () => {
        navigator.clipboard.writeText(key);
        Telegram.WebApp.showAlert('Ключ скопирован: ' + key);
      };
    }

    // Активация ключа
    window.activateKey = function() {
      const input = document.getElementById('keyInput').value.toUpperCase();
      if (input.length !== 6) return Telegram.WebApp.showAlert('Ключ должен быть 6 символов');

      let keys = JSON.parse(localStorage.getItem('generatedKeys') || '[]');
      const keyObj = keys.find(k => k.key === input && !k.used);
      if (!keyObj) return Telegram.WebApp.showAlert('Неверный или использованный ключ');

      keyObj.used = true;
      localStorage.setItem('generatedKeys', JSON.stringify(keys));

      const sub = { expires: keyObj.expires };
      localStorage.setItem('subscription', JSON.stringify(sub));
      closeModal();
      checkSubscription();
      Telegram.WebApp.showAlert('Ключ активирован!');
      switchTab('tab-home');
    };

    window.openKeyModal = () => document.getElementById('keyModal').classList.add('active');
    window.closeModal = () => document.getElementById('keyModal').classList.remove('active');

    // Переключение вкладок
    window.switchTab = function(id, el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      el.classList.add('active');
    };
  </script>
</body>
</html>
