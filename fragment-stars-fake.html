<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Premium Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqZ8Z8Z8Z8Z8Z8Z8Z8Z8Z8Z8Z8Z8Z8Z8Z8",
      authDomain: "premium-mini-app-2025.firebaseapp.com",
      projectId: "premium-mini-app-2025",
      storageBucket: "premium-mini-app-2025.firebasestorage.app",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef1234567890"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.collection = collection;
    window.doc = doc;
    window.setDoc = setDoc;
    window.getDocs = getDocs;
    window.deleteDoc = deleteDoc;
    window.query = query;
    window.where = where;
    window.serverTimestamp = serverTimestamp;
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { margin:0; padding:0; box-sizing:border-box; transition:all .4s ease; }
    body { font-family:'Inter',sans-serif; background:#0a0a0a; color:#fff; min-height:100vh; overflow-x:hidden; }

    .glow-bg { position:fixed; inset:0; pointer-events:none; background:radial-gradient(circle at 50% 25%,rgba(255,255,255,0.15)0%,transparent 70%); animation:pulse 6s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:.5;transform:scale(1)}50%{opacity:.95;transform:scale(1.1)} }

    .container { padding:20px; padding-top:60px; padding-bottom:100px; position:relative; z-index:1; }

    .tab { opacity:0; transform:translateY(20px); transition:all .6s ease; pointer-events:none; }
    .tab.active { opacity:1; transform:none; pointer-events:all; }

    .profile-card { margin:0 16px 32px; padding:40px 24px; text-align:center; background:rgba(255,255,255,0.07); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.12); border-radius:24px; box-shadow:0 12px 40px rgba(0,0,0,0.6); }
    .avatar { width:100px; height:100px; border-radius:50%; border:3px solid rgba(255,255,255,0.3); object-fit:cover; margin-bottom:20px; background:#111; }

    .btn { width:calc(100%-32px); margin:16px; padding:18px; background:#fff; color:#000; font-size:17px; font-weight:600; border:none; border-radius:16px; cursor:pointer; }
    .btn-red { background:#ff4444; color:#fff; }

    .setting-item { margin:0 16px 12px; padding:18px 20px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:16px; display:flex; align-items:center; justify-content:space-between; gap:16px; font-size:16px; }
    .switch { position:relative; width:52px; height:32px; background:#333; border-radius:32px; cursor:pointer; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; inset:0; background:#666; border-radius:32px; transition:.4s; }
    .slider:before { position:absolute; content:""; height:26px; width:26px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.4s; }
    input:checked + .slider { background:#00ff88; }
    input:checked + .slider:before { transform:translateX(20px); }

    .user-list { margin:0 16px; }
    .user-item { padding:16px; background:rgba(255,255,255,0.06); border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }

    .bottom-nav { position:fixed; bottom:0; left:0; right:0; height:84px; background:rgba(15,15,15,0.95); backdrop-filter:blur(20px); border-top:1px solid rgba(255,255,255,0.08); display:flex; z-index:1000; }
    .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:rgba(255,255,255,0.5); cursor:pointer; transform:translateY(20px); opacity:0; transition:all .6s ease; }
    .nav-item.visible { transform:none; opacity:1; }
    .nav-item.active { color:#fff; }
    .nav-item i { font-size:26px; margin-bottom:4px; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(10px); display:none; align-items:center; justify-content:center; z-index:1000; opacity:0; transition:opacity .4s; }
    .modal.active { display:flex; opacity:1; }
    .modal-content { background:#111; padding:32px; border-radius:20px; width:90%; max-width:360px; text-align:center; position:relative; }
    .close-btn { position:absolute; top:12px; right:16px; font-size:28px; cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(255,255,255,0.1); }
  </style>
</head>
<body>

  <div class="glow-bg"></div>

  <div class="container">
    <!-- Главная (до подписки) -->
    <div id="tab-home" class="tab active">
      <div class="profile-card">
        <img id="avatar1" class="avatar" src="">
        <div class="username" id="name1">—</div>
        <div class="first-visit">Первый вход: <span id="visit1">—</span></div>
      </div>
      <button class="btn" onclick="openKeyModal()">Активировать ключ</button>
    </div>

    <!-- Настройки (после подписки) -->
    <div id="tab-settings" class="tab">
      <div class="profile-card">
        <img id="avatar2" class="avatar" src="">
        <div class="username" id="name2">—</div>
        <div class="first-visit">Подписка активна до: <span id="expiresDate">—</span></div>
      </div>
      <div class="setting-item" onclick="switchTab('tab-privacy', this)">Конфиденциальность →</div>
      <div class="setting-item"><i data-feather="user-check"></i> Наставники (скоро)</div>
      <div class="setting-item"><i data-feather="help-circle"></i> Поддержка</div>
    </div>

    <!-- Конфиденциальность -->
    <div id="tab-privacy" class="tab">
      <h2 style="margin:0 16px 20px">Настройки анонимности</h2>
      <div class="setting-item">
        Скрыть профиль полностью
        <label class="switch"><input type="checkbox" id="hideAll"><span class="slider"></span></label>
      </div>
      <div class="setting-item">
        Скрыть только аватарку
        <label class="switch"><input type="checkbox" id="hideAvatar"><span class="slider"></span></label>
      </div>
      <div class="setting-item">
        Скрыть только ник
        <label class="switch"><input type="checkbox" id="hideName"><span class="slider"></span></label>
      </div>
    </div>

    <!-- Темы -->
    <div id="tab-themes" class="tab">
      <h2 style="margin:0 16px 20px">Темы</h2>
      <div class="topic-item"><i data-feather="message-square"></i> Общение <span style="margin-left:auto;opacity:0.6;">0 сообщений</span></div>
      <div class="topic-item"><i data-feather="volume-2"></i> Объявления <span style="margin-left:auto;opacity:0.6;">0 сообщений</span></div>
    </div>

    <!-- Инфо (исчезает после подписки) -->
    <div id="tab-info" class="tab">
      <h2 style="text-align:center; margin:60px 20px">FAQ и информация</h2>
    </div>

    <!-- Подписка (исчезает после активации) -->
    <div id="tab-sub" class="tab">
      <h2 style="text-align:center; margin:60px 20px; opacity:0.7">Магазин подписок — скоро</h2>
    </div>

    <!-- Админ-панель -->
    <div id="tab-admin" class="tab">
      <h2 style="margin:0 16px 20px">Активные подписки</h2>
      <div id="usersList" class="user-list">Загрузка...</div>
      <button class="btn btn-red" onclick="location.reload()">Обновить список</button>
    </div>
  </div>

  <!-- Модалка -->
  <div class="modal" id="keyModal">
    <div class="modal-content">
      <div class="close-btn" onclick="closeModal()">×</div>
      <h3>Активация ключа</h3>
      <input type="text" id="keyInput" placeholder="XXXXXX" maxlength="6">
      <button class="btn" onclick="activateKey()">Активировать</button>
      <p style="margin-top:20px; opacity:0.7">
        Нет ключа? <a href="#" onclick="closeModal(); switchTab('tab-sub')">Приобрести</a>
      </p>
    </div>
  </div>

  <!-- Навигация -->
  <div class="bottom-nav" id="nav">
    <div class="nav-item active" id="nav-home" onclick="switchTab('tab-home')"><i data-feather="home"></i><div class="nav-label">Главная</div></div>
    <div class="nav-item" id="nav-settings" onclick="switchTab('tab-settings')"><i data-feather="settings"></i><div class="nav-label">Настройки</div></div>
    <div class="nav-item" id="nav-themes" onclick="switchTab('tab-themes')"><i data-feather="grid"></i><div class="nav-label">Темы</div></div>
    <div class="nav-item" id="nav-info" onclick="switchTab('tab-info')"><i data-feather="info"></i><div class="nav-label">Инфо</div></div>
    <div class="nav-item" id="nav-sub" onclick="switchTab('tab-sub')"><i data-feather="shopping-cart"></i><div class="nav-label">Подписка</div></div>
    <div class="nav-item" id="nav-admin" onclick="switchTab('tab-admin')"><i data-feather="shield"></i><div class="nav-label">Админ</div></div>
  </div>

  <script type="module">
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    feather.replace();

    const user = Telegram.WebApp.initDataUnsafe.user;
    const isAdmin = user.id === 8223197188;

    // Анимация появления навигации
    function showNavItems() {
      const items = document.querySelectorAll('.nav-item');
      items.forEach((el, i) => {
        setTimeout(() => el.classList.add('visible'), i * 100);
      });
    }

    // Переключение вкладок с анимацией
    window.switchTab = async function(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[onclick="switchTab('${id}')"]`)?.parentElement.classList.add('active');

      if (id === 'tab-admin' && isAdmin) await loadActiveUsers();
      if (id === 'tab-privacy') loadPrivacySettings();
    };

    // Дата окончания подписки
    function formatExpires(expires) {
      if (expires === 'forever') return 'Навсегда';
      const d = new Date(expires);
      return d.toLocaleString('ru-RU');
    }

    // Проверка и применение подписки
    async function checkAndApplySubscription() {
      const q = query(collection(db, "users"), where("userId", "==", user.id));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const data = snap.docs[0].data();
        const expires = data.expires === 'forever' ? 'forever' : data.expires.toMillis();

        document.getElementById('expiresDate').textContent = formatExpires(expires);

        // Убираем ненужные вкладки
        document.getElementById('nav-home').style.display = 'none';
        document.getElementById('nav-info').style.display = 'none';
        document.getElementById('nav-sub').style.display = 'none';

        document.getElementById('nav-settings').classList.add('visible');
        document.getElementById('nav-themes').classList.add('visible');
        if (isAdmin) document.getElementById('nav-admin').classList.add('visible');

        switchTab('tab-settings');
      } else {
        document.getElementById('nav-settings').style.display = 'none';
        document.getElementById('nav-themes').style.display = 'none';
        document.getElementById('nav-admin').style.display = 'none';
      }
      showNavItems();
    }

    // Загрузка активных пользователей в админку
    window.loadActiveUsers = async function() {
      const list = document.getElementById('usersList');
      list.innerHTML = '';
      const snap = await getDocs(collection(db, "users"));
      snap.forEach(doc => {
        const u = doc.data();
        const item = document.createElement('div');
        item.className = 'user-item';
        item.innerHTML = `
          <div>@${u.username || '—no username—'} (${u.firstName || u.userId})<br>
            <small>до ${formatExpires(u.expires === 'forever' ? 'forever' : u.expires.toMillis())}</small>
          </div>
          <button class="btn-red" style="padding:8px 12px;font-size:14px;" onclick="revoke('${doc.id}')">Отключить</button>
        `;
        list.appendChild(item);
      });
    };

    window.revoke = async function(id) {
      if (confirm('Отключить подписку?')) {
        await deleteDoc(doc(db, "users", id));
        loadActiveUsers();
      }
    };

    // Активация ключа
    window.activateKey = async function() {
      const key = document.getElementById('keyInput').value.trim().toUpperCase();
      if (key.length !== 6) return alert('Ключ — 6 символов');

      // Здесь потом будет проверка ключа на сервере. Пока просто 30 дней для теста:
      const expires = Date.now() + 30*24*60*60*1000;

      await setDoc(doc(db, "users", user.id.toString()), {
        userId: user.id,
        username: user.username || null,
        firstName: user.first_name,
        expires: expires,
        created: serverTimestamp()
      }, { merge: true });

      closeModal();
      location.reload();
    };

    // Настройки анонимности
    function loadPrivacySettings() {
      const settings = JSON.parse(localStorage.getItem('privacy') || '{}');
      document.getElementById('hideAll').checked = settings.hideAll || false;
      document.getElementById('hideAvatar').checked = settings.hideAvatar || false;
      document.getElementById('hideName').checked = settings.hideName || false;
    }
    document.querySelectorAll('#tab-privacy input').forEach(cb => {
      cb.addEventListener('change', () => {
        const s = {
          hideAll: document.getElementById('hideAll').checked,
          hideAvatar: document.getElementById('hideAvatar').checked,
          hideName: document.getElementById('hideName').checked
        };
        localStorage.setItem('privacy', JSON.stringify(s));
      });
    });

    window.openKeyModal = () => document.getElementById('keyModal').classList.add('active');
    window.closeModal = () => document.getElementById('keyModal').classList.remove('active');

    // Профиль
    const avatarUrl = user.photo_url || 'https://via.placeholder.com/100/333/fff?text=' + (user.first_name?.[0] || '?');
    document.querySelectorAll('.avatar').forEach(img => img.src = avatarUrl);
    document.querySelectorAll('.username').forEach(el => el.textContent = user.first_name || 'Пользователь');

    checkAndApplySubscription();
  </script>
</body>
</html>
